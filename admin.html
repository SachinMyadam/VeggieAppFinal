<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeggieApp Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      #login-container {
        max-width: 400px;
        margin: 100px auto;
        padding: 30px;
        border-radius: 10px;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      #dashboard-container {
        display: none;
      }
      .edit-btn {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <!-- =========== LOGIN SECTION =========== -->
    <div id="login-container">
      <h2 class="text-center mb-4">Admin Login</h2>
      <form id="login-form">
        <div class="mb-3">
          <label for="login-email" class="form-label">Email</label
          ><input
            type="email"
            class="form-control"
            id="login-email"
            value="admin@veggieapp.com"
            required
          />
        </div>
        <div class="mb-3">
          <label for="login-password" class="form-label">Password</label
          ><input
            type="password"
            class="form-control"
            id="login-password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100">Login</button>
      </form>
    </div>

    <!-- =========== ADMIN DASHBOARD SECTION =========== -->
    <div id="dashboard-container" class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Admin Dashboard</h1>
        <button id="logout-button" class="btn btn-danger">Logout</button>
      </div>
      <div class="card mb-5">
        <div class="card-header"><h3>Add New Vegetable</h3></div>
        <div class="card-body">
          <form id="add-veggie-form" class="row g-3">
            <div class="col-md-6">
              <input
                type="text"
                id="veggie-name"
                class="form-control"
                placeholder="Name"
                required
              />
            </div>
            <div class="col-md-3">
              <input
                type="number"
                id="veggie-price"
                class="form-control"
                placeholder="Price"
                required
              />
            </div>
            <div class="col-md-3">
              <input
                type="text"
                id="veggie-category"
                class="form-control"
                placeholder="Category"
                required
              />
            </div>
            <div class="col-md-9">
              <input
                type="text"
                id="veggie-emoji"
                class="form-control"
                placeholder="Emoji"
                required
              />
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-success w-100">
                Add Vegetable
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="card mb-5">
        <div class="card-header"><h3>Current Vegetables</h3></div>
        <div class="card-body">
          <ul id="vegetables-list" class="list-group"></ul>
        </div>
      </div>
      <hr style="margin: 40px 0" />
      <div class="mt-5">
        <h2 class="mb-4">Incoming Orders</h2>
        <div id="orders-list"></div>
      </div>
    </div>

    <!-- =========== EDIT VEGGIE MODAL (POP-UP) =========== -->
    <div class="modal fade" id="editVeggieModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editVeggieModalLabel">
              Edit Vegetable
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-veggie-form-modal">
              <input type="hidden" id="edit-veggie-id" />
              <div class="mb-3">
                <label for="edit-veggie-price" class="form-label"
                  >New Price</label
                ><input
                  type="number"
                  class="form-control"
                  id="edit-veggie-price"
                  required
                />
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="edit-veggie-available"
                /><label class="form-check-label" for="edit-veggie-available"
                  >Is Available (In Stock)</label
                >
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close</button
            ><button
              type="button"
              id="save-veggie-changes"
              class="btn btn-primary"
            >
              Save changes & Send Notifications
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- =========== JAVASCRIPT LOGIC =========== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        deleteDoc,
        doc,
        onSnapshot,
        query,
        orderBy,
        updateDoc,
        getDoc,
        collectionGroup,
        where,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDZ0_xoKBiGJeWLuEvn_nmBphdLE5pj4eA",
        authDomain: "greengrocerdelivery-7970a.firebaseapp.com",
        projectId: "greengrocerdelivery-7970a",
        storageBucket: "greengrocerdelivery-7970a.appspot.com",
        messagingSenderId: "955703590850",
        appId: "1:955703590850:web:80e0c39f15f0134f5c560b",
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const EXPO_PUSH_ENDPOINT = "https://api.expo.dev/v2/push/send";
      let editVeggieModal;

      document.addEventListener("DOMContentLoaded", () => {
        editVeggieModal = new bootstrap.Modal(
          document.getElementById("editVeggieModal")
        );
      });

      // --- AUTHENTICATION & MAIN DISPLAY ---
      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("login-container").style.display = "none";
          document.getElementById("dashboard-container").style.display =
            "block";
          displayVegetables();
          displayOrders();
        } else {
          document.getElementById("login-container").style.display = "block";
          document.getElementById("dashboard-container").style.display = "none";
        }
      });
      document.getElementById("login-form").addEventListener("submit", (e) => {
        e.preventDefault();
        signInWithEmailAndPassword(
          auth,
          document.getElementById("login-email").value,
          document.getElementById("login-password").value
        ).catch((err) => alert(err.message));
      });
      document
        .getElementById("logout-button")
        .addEventListener("click", () => signOut(auth));
      document
        .getElementById("add-veggie-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await addDoc(collection(db, "vegetables"), {
            name: document.getElementById("veggie-name").value,
            price: Number(document.getElementById("veggie-price").value),
            category: document.getElementById("veggie-category").value,
            emoji: document.getElementById("veggie-emoji").value,
            isAvailable: true,
          });
          e.target.reset();
        });

      // --- VEGETABLE MANAGEMENT ---
      function displayVegetables() {
        const veggiesRef = collection(db, "vegetables");
        onSnapshot(query(veggiesRef, orderBy("name")), (snapshot) => {
          const vegetablesList = document.getElementById("vegetables-list");
          vegetablesList.innerHTML = "";
          snapshot.forEach((veggieDoc) => {
            const veggie = veggieDoc.data();
            const li = document.createElement("li");
            li.className =
              "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `<span>${veggie.emoji} <strong>${veggie.name}</strong> (${veggie.category}) - â‚¹${veggie.price}</span><div><button class="btn btn-warning btn-sm edit-btn">Edit</button><button class="btn btn-danger btn-sm">Delete</button></div>`;
            li.querySelector(".edit-btn").addEventListener("click", () =>
              openEditModal(
                veggieDoc.id,
                veggie.name,
                veggie.price,
                veggie.isAvailable
              )
            );
            li.querySelector(".btn-danger").addEventListener("click", () =>
              deleteDoc(veggieDoc.ref)
            );
            vegetablesList.appendChild(li);
          });
        });
      }
      function openEditModal(id, name, price, isAvailable) {
        document.getElementById("edit-veggie-id").value = id;
        document.getElementById(
          "editVeggieModalLabel"
        ).innerText = `Edit ${name}`;
        document.getElementById("edit-veggie-price").value = price;
        document.getElementById("edit-veggie-available").checked = isAvailable;
        editVeggieModal.show();
      }
      document
        .getElementById("save-veggie-changes")
        .addEventListener("click", async () => {
          const veggieId = document.getElementById("edit-veggie-id").value;
          const newPrice = Number(
            document.getElementById("edit-veggie-price").value
          );
          const newAvailability = document.getElementById(
            "edit-veggie-available"
          ).checked;
          const veggieRef = doc(db, "vegetables", veggieId);
          const veggieDoc = await getDoc(veggieRef);
          const veggieBefore = veggieDoc.data();
          await updateDoc(veggieRef, {
            price: newPrice,
            isAvailable: newAvailability,
          });
          let title = "";
          let body = "";
          if (!veggieBefore.isAvailable && newAvailability) {
            title = "Back in Stock! ðŸŽ‰";
            body = `${veggieBefore.name} is now available to order.`;
          } else if (veggieBefore.price > newPrice) {
            title = "Price Drop Alert! ðŸ’¸";
            body = `The price for ${veggieBefore.name} has dropped to â‚¹${newPrice}!`;
          }
          if (title) {
            await sendNotificationToWatchers(veggieId, title, body);
          }
          editVeggieModal.hide();
        });

      // --- ORDER MANAGEMENT ---
      function displayOrders() {
        const ordersListDiv = document.getElementById("orders-list");
        const ordersRef = collection(db, "orders");
        const q = query(ordersRef, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
          ordersListDiv.innerHTML = "";
          if (snapshot.empty) {
            ordersListDiv.innerHTML = "<p>No new orders yet.</p>";
            return;
          }
          snapshot.forEach((orderDoc) => {
            const order = orderDoc.data();
            const orderId = orderDoc.id;
            const orderCard = document.createElement("div");
            orderCard.className = "card mb-3";
            const orderDate = order.createdAt
              ? order.createdAt.toDate().toLocaleString("en-IN")
              : "Date N/A";
            let itemsHtml = '<ul class="list-group list-group-flush">';
            if (order.items && Array.isArray(order.items)) {
              order.items.forEach((item) => {
                itemsHtml += `<li class="list-group-item">${item.quantity} x ${item.veggie.name}</li>`;
              });
            }
            itemsHtml += "</ul>";
            orderCard.innerHTML = `<div class="card-header d-flex justify-content-between"><span><strong>Order ID:</strong> ${orderId}</span><span class="badge ${
              order.status === "Completed"
                ? "bg-success"
                : "bg-warning text-dark"
            }">${
              order.status || "Pending"
            }</span></div><div class="card-body"><p class="card-text"><strong>Customer:</strong> ${
              order.userEmail || "N/A"
            }</p><p class="card-text"><strong>Date:</strong> ${orderDate}</p><h5 class="card-title">Order Items</h5>${itemsHtml}</div><div class="card-footer d-flex justify-content-between align-items-center"><strong>Total: â‚¹${order.totalPrice.toFixed(
              2
            )}</strong><button class="btn btn-success btn-sm complete-btn">Mark as Complete</button></div>`;

            const completeButton = orderCard.querySelector(".complete-btn");
            if (order.status === "Completed") {
              completeButton.disabled = true;
              completeButton.innerText = "Completed";
            } else {
              completeButton.addEventListener("click", async () => {
                const orderRef = doc(db, "orders", orderId);
                try {
                  await updateDoc(orderRef, { status: "Completed" });
                  const title = "Order Delivered! âœ…";
                  const body =
                    "Your order has been successfully delivered. Enjoy!";
                  await sendNotificationToUser(order.userId, title, body, {
                    orderId,
                  });
                } catch (error) {
                  alert(
                    `Could not update order. Please check Firestore rules.\nError: ${error.message}`
                  );
                }
              });
            }
            ordersListDiv.appendChild(orderCard);
          });
        });
      }

      // --- NOTIFICATION HELPER FUNCTIONS ---
      async function sendNotificationToWatchers(veggieId, title, body) {
        const watchersRef = collection(db, "vegetables", veggieId, "watchers");
        const watchersSnapshot = await getDocs(watchersRef);
        if (!watchersSnapshot.empty) {
          const pushTokens = watchersSnapshot.docs.map((d) =>
            d.id.replace(/-/g, "/")
          );
          const messages = pushTokens.map((token) => ({
            to: token,
            sound: "default",
            title,
            body,
            data: { veggieId },
          }));
          await fetch(EXPO_PUSH_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(messages),
          });
        }
      }
      async function sendNotificationToUser(userId, title, body, data) {
        if (!userId) return;
        const q = query(
          collectionGroup(db, "watchers"),
          where("userId", "==", userId)
        );
        const watchersSnapshot = await getDocs(q);
        if (!watchersSnapshot.empty) {
          const tokens = [
            ...new Set(
              watchersSnapshot.docs.map((d) => d.id.replace(/-/g, "/"))
            ),
          ];
          const messages = tokens.map((token) => ({
            to: token,
            sound: "default",
            title,
            body,
            data,
          }));
          await fetch(EXPO_PUSH_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(messages),
          });
        }
      }
    </script>
  </body>
</html>
